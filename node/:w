const express = require("express");
const bcrypt = require("bcrypt-nodejs");
const jwt = require("jsonwebtoken");
const R = require("ramda");

const { query } = global;

const jwtFilter = require("../filters/jwt-filter.js");
const router = express.Router();

/**
 * @api {post} /attendance/:date Add attendance
 * @apiName AddAttendance
 * @apiGroup Attdendance
 *
 * @apiHeader {String} Authorization Bearer [jwt]
 *
 * @apiSuccessExample {json} Success response:
 * HTTP 200 OK
 * {
 *   success: true,
 *   attendanceId: 5
 * }
 */
router.post("/:date", jwtFilter, async (req, res) => {
  const { userId } = req.decodedToken;

  const activeGroupMappingId = R.path(["activeGroup"],
    R.head(await query("SELECT active_group AS activeGroup FROM users WHERE user_id = ?", userId)));

  const activeGroupId = R.path(["groupId"],
    R.head(await query("SELECT group_id AS groupId FROM user_group WHERE user_group_id = ?", activeGroupMappingId)));

  const { date } = req.params;
  const r = await query("INSERT INTO attendance (date, group_id) VALUES (?, ?)", [ date, activeGroupId ]);
  res.json({ success: true, attendanceId: r.insertId });
});

router.get("/users/:attendanceId", async (req, res) => {
  const { attendanceId } = req.params;

  try{

    const  { groupId } = R.head(await query("SELECT group_id AS groupId FROM attendance WHERE attendance_id = ?", attendanceId));

    const users = await query(`
      SELECT
        users.user_id AS userId,
        users.name,
        (SELECT COUNT(1) != 0
          FROM attendance_users
          WHERE attendance_users.user_id = userId AND attendance_id = ?) AS isPresent
      FROM users
      JOIN user_group ON user_group.user_id = users.user_id
      WHERE group_id = ? AND users.privilege = 0
    `, [ attendanceId, groupId]);

    res.json(users);

  } catch(e) {
    return res.json({
      error: "Attendance not found!"
    })
  }

});

/**
 * @api {post} /attendance/:groupId/:date/:userId Add user to attendance
 * @apiName AddUser
 * @apiGroup Attdendance
 *
 * @apiHeader {String} Authorization Bearer [jwt]
 *
 * @apiSuccessExample {json} Success response:
 * HTTP 200 OK
 * {
 *   success: true
 * }
 */
router.post("/:groupId/:date/:userId", async (req, res) => {
  const { groupId, date, userId } = req.params;

  const existingAttendance = R.head(await query(`
    SELECT
      attendance_id AS attendanceId,
      date,
      group_id AS groupId
    FROM attendance
    WHERE date = ? AND group_id = ?
  `, [ date, groupId ]));

  if (R.isNil(existingAttendance)) {
    await query("INSERT INTO attendance (date, group_id) VALUES (?, ?)", [ date, groupId ]);
  }

  const attendanceObject = R.ifElse(
    R.isNil(existingAttendance),
    R.head(await query(`
     SELECT
       attendance_id AS attendanceId,
       date,
       group_id AS groupId
     FROM attendance
     WHERE date = ? AND group_id = ?
   `, [ date, groupId ])),
   existingAttendance);

   const { attendanceId } = attendanceObject;

   try {
     await query("INSERT INTO attendance_users (attendance_id, user_id) VALUES (?, ?)", [ attendanceId, userId ]);

     res.json({
       success: true
     });
   } catch ( error ) {
     res.json({
       success: false,
       error
     });
   }
});

/**
 * @api {get} /attendance Get all attendances from active group
 * @apiName GetAllAtendances
 * @apiGroup Attdendance
 *
 * @apiHeader {String} Authorization Bearer [jwt]
 *
 * @apiSuccessExample {json} Success response:
 * HTTP 200 OK
 * [{
 *    attendanceId: 3,
 *    date: "...",
 *    isPresent: true/false
 * },{
 * ...
 * }]
 */
router.get("/", jwtFilter, async (req, res) => {
  const { userId, privilege } = req.decodedToken;

  const activeGroupMappingId = R.path(["activeGroup"],
    R.head(await query("SELECT active_group AS activeGroup FROM users WHERE user_id = ?", userId)));

  const activeGroupId = R.path(["groupId"],
    R.head(await query("SELECT group_id AS groupId FROM user_group WHERE user_group_id = ?", activeGroupMappingId)));

    const attendanceList = await query(`
      SELECT
        attendance_id AS attendanceId,
        DATE_FORMAT(date, "%d/%m/%Y") AS date,
        (SELECT
          COUNT(1) != 0
         FROM attendance_users
         WHERE
           attendance_users.attendance_id = attendanceId
           AND
           attendance_users.user_id = ?
        ) AS isPresent
      FROM attendance
      WHERE group_id = ?
    `, [ userId, activeGroupId ]);

    res.json(attendanceList);
});

router.get("/:attendanceId/table", jwtFilter, async (req, res) => {
  const { userId, privilege } = req.decodedToken;
  const { attendanceId } = req.params;

  const activeGroupMappingId = R.path(["activeGroup"],
    R.head(await query("SELECT active_group AS activeGroup FROM users WHERE user_id = ?", userId)));

  const activeGroupId = R.path(["groupId"],
    R.head(await query("SELECT group_id AS groupId FROM user_group WHERE user_group_id = ?", activeGroupMappingId)));

  const userList = await query(`
    SELECT 
      users.user_id AS userId,
      users.name
    FROM user_group
    JOIN users ON users.user_id = user_group.user_id
    WHERE user_group.group_id = ?
  `, Array.of(activeGroupId));

  console.log(userList);

  const resultWithDates = await Promise.all(R.map(async (user) => {
    const { userId } = user;
    const dates = await query(`
      SELECT
        DATE_FORMAT(date, "%d/%m/%Y") AS date,
      FROM attendance_users
      JOIN attendance ON attendance.attendance_id = attendance_users.attendance_id
      WHERE user_id = ?
    `, Array.of(userId));
    return R.merge(user, { dates });
  }, userList));

  res.json(resultWithDates);
});

/**
 * @api {delete} /attendance/:groupId/:date/:userId Remove user from attendance
 * @apiName RemoveUser
 * @apiGroup Attdendance
 *
 * @apiHeader {String} Authorization Bearer [jwt]
 *
 * @apiSuccessExample {json} Success response:
 * HTTP 200 OK
 * {
 *   success: true
 * }
 */
router.delete("/:groupId/:date/:userId", async (req, res) => {
  const { groupId, date, userId } = req.params;

  const attendanceObject = R.head(await query(`
    SELECT
      attendance_id AS attendanceId,
      date,
      group_id AS groupId
    FROM attendance
    WHERE date = ? AND group_id = ?
  `, [ date, groupId ]));

  if (R.isNil(attendanceObject)) {
    return res.json({
      error: "Attendance does not exist!"
    })
  }

  const { attendanceId } = attendanceObject;

  await query("DELETE FROM attendance_users WHERE attendance_id = ? AND user_id = ?", [ attendanceId, userId ] );

  res.json({ success: true });
});


/**
 * @api {get} /attendance/:attendanceId/:userId/toggle Toggle attendance for user
 * @apiName ToggleAttendance
 * @apiGroup Attdendance
 *
 * @apiHeader {String} Authorization Bearer [jwt]
 *
 * @apiSuccessExample {json} Success response:
 * HTTP 200 OK
 * {
 *   success: true
 * }
 */
router.get("/:attendanceId/:userId/toggle", async (req, res) => {
  const { attendanceId, userId } = req.params;

  const userAttendance = R.head(await query("SELECT * FROM attendance_users WHERE user_id = ? AND attendance_id = ?", [ userId, attendanceId ]));

  if (R.isNil(userAttendance)) {
    // insert it
    await query("INSERT INTO attendance_users (attendance_id, user_id) VALUES (?, ?)", [ attendanceId, userId ]);
  } else {
    // delete it
    await query("DELETE FROM attendance_users WHERE attendance_id = ? AND user_id = ?", [ attendanceId, userId ] );
  }

  res.json({ success: true });
});

module.exports = router;
